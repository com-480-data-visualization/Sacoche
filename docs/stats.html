<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Boston Marathon Statistics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; 
      padding: 20px; 
      min-height: 100vh;
    }
    
    h1 { 
      text-align: center; 
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .year-selector {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .year-selector select {
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 25px;
      border: none;
      background: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      outline: none;
      cursor: pointer;
    }
    
    #main { 
      display: flex; 
      gap: 20px; 
      max-width: 1400px;
      margin: 0 auto;
    }
    
    #filtersPanel { 
      flex: 0 0 280px; 
    }
    
    .card { 
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 20px; 
      border-radius: 15px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .card h2 { 
      margin-top: 0; 
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    
    .filter-section {
      margin-bottom: 20px;
    }
    
    .filter-section strong {
      display: block;
      margin-bottom: 8px;
      color: #555;
    }
    
    #filtersPanel label { 
      display: block;
      margin: 5px 0;
      cursor: pointer;
    }
    
    #filtersPanel button { 
      margin-top: 15px; 
      margin-right: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    #applyFiltersBtn {
      background: #667eea;
      color: white;
    }
    
    #applyFiltersBtn:hover {
      background: #5a6fd8;
      transform: translateY(-2px);
    }
    
    #resetFiltersBtn {
      background: #e74c3c;
      color: white;
    }
    
    #resetFiltersBtn:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }
    
    #statsPanel { 
      flex: 1; 
    }
    
    #summaryStats { 
      margin-bottom: 20px; 
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    
    .stat-item {
      text-align: center;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
    }
    
    .stat-value { 
      font-size: 1.8em; 
      font-weight: bold; 
      color: #667eea;
      display: block;
    }
    
    .stat-label { 
      font-size: 0.9em; 
      color: #666;
      margin-top: 5px;
    }
    
    #ageRangeSlider {
      width: 100%;
      margin: 10px 0;
    }
    
    #levelSelect {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    .age-range-display {
      text-align: center;
      margin-top: 5px;
      font-weight: bold;
      color: #667eea;
    }
    
    #chartCard {
      height: 400px;
    }
    
    #finishTimeChart {
      max-height: 350px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 1.2em;
    }
    
    .error-message {
      background: rgba(231, 76, 60, 0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 20px;
      text-align: center;
      font-weight: bold;
    }
    
    .success-message {
      background: rgba(46, 204, 113, 0.9);
      color: white;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
    
    .data-info {
      background: rgba(52, 152, 219, 0.9);
      color: white;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      font-size: 0.9em;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .filter-applied {
      background: rgba(46, 204, 113, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 0.9em;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üèÉ‚Äç‚ôÇÔ∏è Boston Marathon Statistics Dashboard</h1>
  
  <div class="year-selector">
    <label for="yearSelect" style="color: white; margin-right: 10px; font-size: 1.1em;">Select Year:</label>
    <select id="yearSelect">
      <option value="">Loading...</option>
    </select>
  </div>
  
  <div id="loadingMessage" class="loading">
    <div class="spinner"></div>
    Loading marathon data from stats_marathon_2015_2017.json...
  </div>
  
  <div id="main" style="display: none;">
    <div id="filtersPanel">
      <div class="card">
        <h2>üîç Filters</h2>
        
        <div id="filterAppliedMessage" class="filter-applied" style="display: none;">
          <span id="filterAppliedText"></span>
        </div>
        
        <div id="dataInfo" class="data-info" style="display: none;">
          <strong>üìä Data Loaded:</strong>
          <div id="dataStats"></div>
        </div>
        
        <div class="filter-section">
          <strong>Age Range</strong>
          <input type="range" id="ageRangeSlider" min="0" max="6" step="1" value="6">
          <div class="age-range-display" id="ageRangeDisplay">All Ages</div>
        </div>
        
        <div class="filter-section">
          <strong>Gender</strong>
          <label><input type="checkbox" name="gender" value="1" checked> üë® Male</label>
          <label><input type="checkbox" name="gender" value="2" checked> üë© Female</label>
        </div>
        
        <div class="filter-section">
          <strong>Runner Level</strong>
          <select id="levelSelect" multiple size="4">
            <option value="D√©butant" selected>ü•â D√©butant</option>
            <option value="Interm√©diaire" selected>ü•à Interm√©diaire</option>
            <option value="Avanc√©" selected>ü•á Avanc√©</option>
            <option value="Elite" selected>üèÜ Elite</option>
          </select>
        </div>
        
        <div>
          <button type="button" id="applyFiltersBtn">Apply Filters</button>
          <button type="button" id="resetFiltersBtn">Reset Filters</button>
        </div>
      </div>
    </div>
    
    <div id="statsPanel">
      <div id="summaryStats" class="card">
        <h2>üìä Summary Statistics</h2>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-value" id="totalRunnersValue">-</span>
            <div class="stat-label">Total Runners</div>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="avgTimeValue">-</span>
            <div class="stat-label">Average Time</div>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="fastestTimeValue">-</span>
            <div class="stat-label">Fastest Time</div>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="slowestTimeValue">-</span>
            <div class="stat-label">Slowest Time</div>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="medianTimeValue">-</span>
            <div class="stat-label">Median Time</div>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="completionRateValue">100.0%</span>
            <div class="stat-label">Completion Rate</div>
          </div>
        </div>
        
        <div id="filteredInfo" class="data-info" style="margin-top: 15px; display: none;">
          <strong>üîç Filtered Results:</strong>
          <span id="filteredCount">0 segments</span> showing <span id="filteredRunners">0 runners</span>
        </div>
      </div>
      
      <div id="chartCard" class="card">
        <h2>üìà Performance by Age Group & Level</h2>
        <canvas id="finishTimeChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    let marathonStats = {};
    let currentChart = null;
    
    // Age range mappings
    const ageRanges = ["18-29", "30-39", "40-49", "50-59", "60-69", "70+"];
    
    // Function to get URL parameters
    function getURLParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        runnerLevel: urlParams.get('runnerLevel'),
        ageRange: urlParams.get('ageRange'),
        gender: urlParams.get('gender'),
        year: urlParams.get('year')
      };
    }
    
    // Function to apply URL parameters to filters
    function applyURLFilters() {
      const params = getURLParameters();
      console.log('üîó URL Parameters detected:', params);
      
      let filterApplied = false;
      let appliedFilters = [];
      
      // Apply runner level filter
      if (params.runnerLevel) {
        // First deselect all levels
        document.querySelectorAll('#levelSelect option').forEach(opt => opt.selected = false);
        
        // Then select the specific level from URL
        const levelOption = document.querySelector(`#levelSelect option[value="${params.runnerLevel}"]`);
        if (levelOption) {
          levelOption.selected = true;
          filterApplied = true;
          appliedFilters.push(`Level: ${params.runnerLevel}`);
          console.log('‚úÖ Applied runnerLevel filter:', params.runnerLevel);
        }
      }
      
      // Apply age range filter
      if (params.ageRange) {
        const ageIndex = ageRanges.indexOf(params.ageRange);
        if (ageIndex !== -1) {
          document.getElementById("ageRangeSlider").value = ageIndex;
          updateAgeRangeDisplay();
          filterApplied = true;
          appliedFilters.push(`Age: ${params.ageRange}`);
          console.log('‚úÖ Applied age filter:', params.ageRange);
        }
      }
      
      // Apply gender filter
      if (params.gender) {
        // First deselect all genders
        document.querySelectorAll('input[name="gender"]').forEach(cb => cb.checked = false);
        
        // Then select the specific gender
        const genderCheckbox = document.querySelector(`input[name="gender"][value="${params.gender}"]`);
        if (genderCheckbox) {
          genderCheckbox.checked = true;
          filterApplied = true;
          const genderLabel = params.gender === '1' ? 'Male' : 'Female';
          appliedFilters.push(`Gender: ${genderLabel}`);
          console.log('‚úÖ Applied gender filter:', genderLabel);
        }
      }
      
      // Apply year filter
      if (params.year && marathonStats[params.year]) {
        document.getElementById("yearSelect").value = params.year;
        filterApplied = true;
        appliedFilters.push(`Year: ${params.year}`);
        console.log('‚úÖ Applied year filter:', params.year);
      }
      
      // Show applied filter message
      if (filterApplied) {
        const messageElement = document.getElementById('filterAppliedMessage');
        const textElement = document.getElementById('filterAppliedText');
        textElement.textContent = `üéØ Auto-applied filters: ${appliedFilters.join(', ')}`;
        messageElement.style.display = 'block';
        console.log('üéØ Applied filters from URL:', appliedFilters);
        
        // Apply the filters immediately
        setTimeout(() => {
          updateDashboard();
        }, 100);
      }
    }
    
    // Load data from JSON file
    async function loadMarathonData() {
      try {
        console.log('üîÑ Attempting to load stats_marathon_2015_2017.json...');
        
        const response = await fetch("stats_marathon_2015_2017.json");
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ JSON data loaded successfully:', data);
        
        // Validate data structure
        if (!data || typeof data !== 'object') {
          throw new Error('Invalid JSON structure - expected object');
        }
        
        const years = Object.keys(data);
        if (years.length === 0) {
          throw new Error('No years found in data');
        }
        
        console.log(`üìÖ Found ${years.length} years of data: ${years.join(', ')}`);
        
        // Validate each year has the expected structure
        years.forEach(year => {
          const yearData = data[year];
          if (!yearData.segments || !Array.isArray(yearData.segments)) {
            console.warn(`‚ö†Ô∏è Year ${year} missing segments array`);
          } else {
            console.log(`üìä Year ${year}: ${yearData.segments.length} segments, ${yearData.total_runners} total runners`);
          }
        });
        
        marathonStats = data;
        
        // Show success message and data info
        showDataInfo();
        
        // Hide loading message and show main content
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('main').style.display = 'flex';
        
        // Initialize the app
        initializeApp();
        
        // Apply URL filters after initialization
        applyURLFilters();
        
        console.log('üéâ Dashboard initialized successfully!');
        
      } catch (error) {
        console.error('‚ùå Error loading marathon data:', error);
        showErrorMessage(`Failed to load data: ${error.message}`);
      }
    }
    
    function showErrorMessage(message) {
      document.getElementById('loadingMessage').innerHTML = `
        <div class="error-message">
          <h3>‚ùå Error Loading Data</h3>
          <p>${message}</p>
          <p>Please ensure the file 'stats_marathon_2015_2017.json' is in the same directory as this HTML file.</p>
          <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: white; color: #e74c3c; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
            üîÑ Retry
          </button>
        </div>
      `;
    }
    
    function showDataInfo() {
      const years = Object.keys(marathonStats);
      const totalSegments = years.reduce((sum, year) => sum + (marathonStats[year].segments?.length || 0), 0);
      const totalRunners = years.reduce((sum, year) => sum + (marathonStats[year].total_runners || 0), 0);
      
      document.getElementById('dataInfo').style.display = 'block';
      document.getElementById('dataStats').innerHTML = `
        üìÖ ${years.length} years (${years.join(', ')})<br>
        üìä ${totalSegments} data segments<br>
        üèÉ‚Äç‚ôÇÔ∏è ${totalRunners.toLocaleString()} total runners
      `;
    }

    function initializeApp() {
      const yearSelect = document.getElementById("yearSelect");
      yearSelect.innerHTML = "";
      
      // Sort years and add to dropdown
      const years = Object.keys(marathonStats).sort();
      years.forEach(year => {
        const opt = document.createElement("option");
        opt.value = year;
        opt.textContent = year;
        yearSelect.appendChild(opt);
      });
      
      // Select the first year by default
      yearSelect.value = years[0];
      
      setupEventListeners();
      updateAgeRangeDisplay();
      updateDashboard();
    }

    function setupEventListeners() {
      document.getElementById("yearSelect").addEventListener("change", updateDashboard);
      document.getElementById("applyFiltersBtn").addEventListener("click", updateDashboard);
      document.getElementById("resetFiltersBtn").addEventListener("click", resetFilters);
      document.getElementById("ageRangeSlider").addEventListener("input", updateAgeRangeDisplay);
    }

    function updateAgeRangeDisplay() {
      const slider = document.getElementById("ageRangeSlider");
      const display = document.getElementById("ageRangeDisplay");
      const value = parseInt(slider.value);
      
      if (value === 6) {
        display.textContent = "All Ages";
      } else {
        display.textContent = ageRanges[value];
      }
    }

    function resetFilters() {
      document.getElementById("ageRangeSlider").value = 6;
      document.querySelectorAll('input[name="gender"]').forEach(cb => cb.checked = true);
      document.querySelectorAll('#levelSelect option').forEach(opt => opt.selected = true);
      document.getElementById('filterAppliedMessage').style.display = 'none';
      updateAgeRangeDisplay();
      updateDashboard();
    }

    function getFilteredData() {
      const selectedYear = document.getElementById("yearSelect").value;
      const selectedAgeRange = parseInt(document.getElementById("ageRangeSlider").value);
      const selectedGenders = Array.from(document.querySelectorAll('input[name="gender"]:checked')).map(cb => parseInt(cb.value));
      const selectedLevels = Array.from(document.getElementById("levelSelect").selectedOptions).map(opt => opt.value);
      
      console.log('üîç Filtering data:', {
        year: selectedYear,
        ageRange: selectedAgeRange === 6 ? 'All' : ageRanges[selectedAgeRange],
        genders: selectedGenders,
        levels: selectedLevels
      });
      
      if (!marathonStats[selectedYear] || !marathonStats[selectedYear].segments) {
        console.warn(`‚ö†Ô∏è No segments data for year ${selectedYear}`);
        return [];
      }
      
      const segments = marathonStats[selectedYear].segments;
      console.log(`üìä Total segments for ${selectedYear}:`, segments.length);
      
      const filtered = segments.filter(segment => {
        const ageMatch = selectedAgeRange === 6 || ageRanges[selectedAgeRange] === segment.age_range;
        const genderMatch = selectedGenders.includes(segment.gender);
        const levelMatch = selectedLevels.includes(segment.level);
        const hasData = segment.count > 0;
        
        return ageMatch && genderMatch && levelMatch && hasData;
      });
      
      console.log(`‚úÖ Filtered to ${filtered.length} segments`);
      return filtered;
    }

    function updateDashboard() {
      const selectedYear = document.getElementById("yearSelect").value;
      const yearData = marathonStats[selectedYear];
      
      if (!yearData) {
        console.error('‚ùå No data for selected year:', selectedYear);
        return;
      }
      
      const filteredSegments = getFilteredData();
      
      // Calculate filtered totals
      const filteredRunners = filteredSegments.reduce((sum, seg) => sum + seg.count, 0);
      
      // Update summary stats (using global year data)
      document.getElementById("totalRunnersValue").textContent = yearData.total_runners.toLocaleString();
      document.getElementById("avgTimeValue").textContent = yearData.mean_time || '-';
      document.getElementById("fastestTimeValue").textContent = yearData.fastest_time || '-';
      document.getElementById("slowestTimeValue").textContent = yearData.slowest_time || '-';
      document.getElementById("medianTimeValue").textContent = yearData.median_time || '-';
      document.getElementById("completionRateValue").textContent = ((yearData.completion_rate || 1) * 100).toFixed(1) + "%";
      
      // Update filtered info
      document.getElementById('filteredInfo').style.display = 'block';
      document.getElementById('filteredCount').textContent = `${filteredSegments.length} segments`;
      document.getElementById('filteredRunners').textContent = `${filteredRunners.toLocaleString()} runners`;
      
      // Update chart
      updateChart(filteredSegments);
      
      console.log(`üìà Dashboard updated for ${selectedYear}: ${filteredSegments.length} segments, ${filteredRunners} runners`);
    }

    function updateChart(segments) {
      const ctx = document.getElementById('finishTimeChart').getContext('2d');
      
      if (currentChart) {
        currentChart.destroy();
      }
      
      if (segments.length === 0) {
        // Show empty chart message
        ctx.font = '16px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('No data available for current filters', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
      }
      
      // Group data by age range and level
      const chartData = {};
      const ageGroups = [...new Set(segments.map(s => s.age_range))].sort((a, b) => {
        return ageRanges.indexOf(a) - ageRanges.indexOf(b);
      });
      const levels = ['Elite', 'Avanc√©', 'Interm√©diaire', 'D√©butant'];
      
      console.log('üìä Chart age groups:', ageGroups);
      console.log('üìä Chart levels:', levels);
      
      levels.forEach(level => {
        chartData[level] = ageGroups.map(age => {
          const segment = segments.find(s => s.age_range === age && s.level === level);
          return segment ? segment.count : 0;
        });
      });
      
      const colors = {
        'Elite': '#e74c3c',
        'Avanc√©': '#f39c12',
        'Interm√©diaire': '#3498db',
        'D√©butant': '#2ecc71'
      };
      
      const datasets = levels.map(level => ({
        label: level,
        data: chartData[level],
        backgroundColor: colors[level] + '80', // Add transparency
        borderColor: colors[level],
        borderWidth: 2,
        borderRadius: 4,
        borderSkipped: false,
      }));
      
      currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ageGroups,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                font: {
                  weight: 'bold'
                }
              }
            },
            title: {
              display: true,
              text: 'Runner Distribution by Age Group and Performance Level',
              font: {
                size: 16,
                weight: 'bold'
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              borderColor: 'rgba(255,255,255,0.2)',
              borderWidth: 1,
              callbacks: {
                afterLabel: function(context) {
                  // Find the segment for additional info
                  const segment = segments.find(s => 
                    s.age_range === context.label && s.level === context.dataset.label
                  );
                  if (segment && segment.mean_time) {
                    return `Avg Time: ${segment.mean_time}`;
                  }
                  return '';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Runners',
                font: {
                  weight: 'bold',
                  size: 14
                }
              },
              grid: {
                color: 'rgba(0,0,0,0.1)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Age Groups',
                font: {
                  weight: 'bold',
                  size: 14
                }
              },
              grid: {
                display: false
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
      
      console.log('üìà Chart updated with', segments.length, 'segments');
    }

    // Start loading data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Page loaded, starting data load...');
      loadMarathonData();
    });
    
    // Also try to load data immediately in case DOMContentLoaded already fired
    loadMarathonData();
  </script>
</body>
</html>
